<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Christy's Learning Hub</title>
    <link rel="stylesheet" href="index.css">
</head>

<body>
    <header>
        <h1>Â¡Hola Christy!</h1>
        <p>Choose an adventure to start learning!</p>

        <div class="stats-box" id="visitor-stats">
            <span id="visit-count-tag">Visits: 0</span>
            <span class="divider">|</span>
            <span id="streak-tag" class="streak-tag">Streak: 0 ðŸ”¥</span>
            <span class="divider">|</span>
            <span id="last-visit-tag">First time here? I miss ya!</span>
        </div>
    </header>

    <div id="badge-shelf" class="badge-shelf">
        <!-- Guinea Pig Badges -->
    </div>

    <!-- Lightbox for Badges -->
    <div id="badge-modal" onclick="closeBadgeModal()">
        <img id="modal-img" src="" alt="Badge Preview">
    </div>

    <div class="hub-container" id="hub-container">
        <!-- Rendered Programmatically -->
    </div>

    <!-- Hidden focus for mobile cheat codes -->
    <div style="margin-top: 50px; text-align: center; opacity: 0.3;">
        <input type="text" id="cheat-box"
            style="background: transparent; border: 1px solid var(--pink-primary); border-radius: 10px; padding: 5px; color: var(--pink-dark); font-size: 0.8rem; text-align: center; outline: none;">
    </div>

    <script src="common.js"></script>
    <script>
        function renderHub() {
            const container = document.getElementById('hub-container');

            hubGames.forEach(game => {
                const gameLink = document.createElement('a');
                gameLink.href = game.href;
                gameLink.className = 'game-link';

                gameLink.innerHTML = `
                    <div class="badge">${game.badge}</div>
                    <div class="icon-box" style="background: ${game.iconBg}">
                        <svg viewBox="0 0 24 24">
                            ${game.icon}
                        </svg>
                    </div>
                    <div class="game-info">
                        <h2>${game.title}</h2>
                        <p>${game.description}</p>
                    </div>
                `;

                container.appendChild(gameLink);
            });
        }

        function trackVisits() {
            let visits = parseInt(localStorage.getItem('visitCount')) || 0;
            let lastVisit = localStorage.getItem('lastVisit');

            // Increment count for this session (only once per page load)
            visits++;
            localStorage.setItem('visitCount', visits);

            // Display stats
            document.getElementById('visit-count-tag').innerText = `Visits: ${visits}`;

            if (lastVisit) {
                const lastDate = new Date(lastVisit);
                const now = new Date();

                // Set both to midnight for accurate day comparison
                const d1 = new Date(lastDate.getFullYear(), lastDate.getMonth(), lastDate.getDate());
                const d2 = new Date(now.getFullYear(), now.getMonth(), now.getDate());

                const diffTime = Math.abs(d2 - d1);
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                let relativeText = "";
                if (diffDays === 0) relativeText = "Today";
                else if (diffDays === 1) relativeText = "Yesterday";
                else relativeText = `${diffDays} days ago`;

                document.getElementById('last-visit-tag').innerText = `Last visit: ${relativeText}`;
            } else {
                document.getElementById('last-visit-tag').innerText = "I miss ya!";
            }

            // Update last visit for NEXT time
            localStorage.setItem('lastVisit', new Date().toISOString());

            // Handle Streak and Badges
            const stats = getStats();
            document.getElementById('streak-tag').innerText = `Streak: ${stats.streak} ðŸ”¥`;

            renderBadges(stats.badges);
        }

        function renderBadges(unlockedCount) {
            const shelf = document.getElementById('badge-shelf');
            shelf.innerHTML = '';

            const pigs = [
                { id: 1, name: 'Peanut' },
                { id: 2, name: 'Coco' },
                { id: 3, name: 'Marshmallow' },
                { id: 4, name: 'Ginger' },
                { id: 5, name: 'Rex' },
                { id: 6, name: 'Daisy' }
            ];

            pigs.forEach((pig, index) => {
                const isLocked = index >= unlockedCount;
                const badge = document.createElement('div');
                badge.className = `badge-item ${isLocked ? 'locked' : ''}`;

                if (isLocked) {
                    badge.innerHTML = `
                        <div style="font-size: 0.7rem; text-align: center;">Locked<br>${(index + 1) * 3} Days</div>
                    `;
                } else {
                    badge.innerHTML = `
                        <img src="images/Guineapig${pig.id}.png" alt="${pig.name}">
                        <div style="position: absolute; bottom: -20px; font-size: 0.7rem; font-weight: 800; color: var(--pink-dark);">${pig.name}</div>
                    `;
                    badge.style.cursor = 'zoom-in';
                    badge.onclick = () => openBadgeModal(`images/Guineapig${pig.id}.png`);
                }
                shelf.appendChild(badge);
            });
        }

        let audioCtx = null;
        let melodyInterval = null;

        function playHappyMusic() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const melody = [64, 66, 68, 69, 71, 73, 75, 76]; // Major scale
            let noteIdx = 0;

            function playNote(midi, time, dur) {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(440 * Math.pow(2, (midi - 69) / 12), time);
                gain.gain.setValueAtTime(0, time);
                gain.gain.linearRampToValueAtTime(0.1, time + 0.05);
                gain.gain.linearRampToValueAtTime(0, time + dur);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(time);
                osc.stop(time + dur);
            }

            const startTime = audioCtx.currentTime;
            let nextTime = startTime;

            function scheduler() {
                const midi = melody[noteIdx % melody.length];
                playNote(midi, nextTime, 0.4);
                nextTime += 0.5;
                noteIdx++;
                melodyInterval = setTimeout(scheduler, 500);
            }
            scheduler();
        }

        function stopHappyMusic() {
            if (melodyInterval) {
                clearTimeout(melodyInterval);
                melodyInterval = null;
            }
        }

        function openBadgeModal(src) {
            const modal = document.getElementById('badge-modal');
            const img = document.getElementById('modal-img');
            img.src = src;
            modal.classList.add('open');
            document.body.style.overflow = 'hidden';

            playHappyMusic();
        }

        function closeBadgeModal() {
            const modal = document.getElementById('badge-modal');
            modal.classList.remove('open');
            document.body.style.overflow = '';

            stopHappyMusic();
        }

        function handleSecretCommands() {
            let inputBuffer = "";
            const cheatBox = document.getElementById('cheat-box');

            // Handle global typing (Computer)
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                if (e.key === 'Enter') {
                    const cmd = inputBuffer.trim().toLowerCase();
                    processCommand(cmd);
                    inputBuffer = "";
                } else if (e.key.length === 1) {
                    inputBuffer += e.key;
                }
            });

            // Handle specific input (Mobile)
            cheatBox.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    processCommand(cheatBox.value.trim().toLowerCase());
                    cheatBox.value = "";
                }
            });

            function processCommand(cmd) {
                if (cmd === "reset") {
                    localStorage.clear();
                    window.location.reload();
                } else if (cmd.startsWith("goto")) {
                    const days = parseInt(cmd.replace("goto", ""));
                    if (!isNaN(days) && days > 0) {
                        mockStreak(days);
                    }
                }
            }

            function mockStreak(count) {
                const dates = [];
                for (let i = 0; i < count; i++) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    dates.push(d.toISOString().split('T')[0]);
                }
                localStorage.setItem('playDays', JSON.stringify(dates));
                window.location.reload();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            trackVisits();
            renderHub();
            handleSecretCommands();
        });
    </script>

</body>

</html>